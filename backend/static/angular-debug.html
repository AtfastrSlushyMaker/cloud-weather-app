<!DOCTYPE html>
<html>
<head>
    <title>Angular Debug Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 15px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 3px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .clear-btn { background: #6c757d; }
        .clear-btn:hover { background: #545b62; }
    </style>
</head>
<body>
    <h1>Angular vs Native Fetch Debug</h1>
    
    <div class="test-section">
        <h3>Environment Info</h3>
        <div id="info" class="result info"></div>
    </div>

    <div class="test-section">
        <h3>Native Fetch Tests</h3>
        <button onclick="testNativeFetch()">Test Native Fetch</button>
        <button onclick="testXHR()">Test XMLHttpRequest</button>
        <button onclick="testWithCredentials()">Test With Credentials</button>
    </div>

    <div class="test-section">
        <h3>Angular Simulation</h3>
        <button onclick="testAngularLikeRequest()">Test Angular-like Request</button>
        <button onclick="testWithHeaders()">Test With Angular Headers</button>
        <button onclick="testCORS()">Test CORS Preflight</button>
    </div>

    <div class="test-section">
        <button onclick="clearResults()" class="clear-btn">Clear Results</button>
        <div id="result"></div>
    </div>

    <script>
        // Show environment info
        document.getElementById('info').innerHTML = 
            '<strong>User Agent:</strong> ' + navigator.userAgent + '<br>' +
            '<strong>Location:</strong> ' + window.location.href + '<br>' +
            '<strong>Time:</strong> ' + new Date().toString() + '<br>' +
            '<strong>Connection:</strong> ' + (navigator.onLine ? 'Online' : 'Offline');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'result ' + type;
            div.innerHTML = '<strong>' + new Date().toLocaleTimeString() + ':</strong> ' + message;
            document.getElementById('result').appendChild(div);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
        }

        async function testNativeFetch() {
            log('Testing native fetch API...');
            try {
                const response = await fetch('/api/weather?city=London');
                log('Native fetch status: ' + response.status, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('Native fetch success: ' + data.name + ', ' + data.main.temp + '°C', 'success');
                } else {
                    const errorText = await response.text();
                    log('Native fetch error: ' + errorText, 'error');
                }
            } catch (error) {
                log('Native fetch exception: ' + error.name + ' - ' + error.message, 'error');
            }
        }

        function testXHR() {
            log('Testing XMLHttpRequest...');
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/weather?city=London', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            log('XHR success: ' + data.name + ', ' + data.main.temp + '°C', 'success');
                        } catch (e) {
                            log('XHR parse error: ' + e.message, 'error');
                        }
                    } else {
                        log('XHR error: ' + xhr.status + ' - ' + xhr.statusText, 'error');
                    }
                }
            };
            
            xhr.onerror = function() {
                log('XHR network error', 'error');
            };
            
            xhr.send();
        }

        async function testWithCredentials() {
            log('Testing fetch with credentials...');
            try {
                const response = await fetch('/api/weather?city=London', {
                    credentials: 'same-origin'
                });
                log('Credentials fetch status: ' + response.status, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('Credentials fetch success: ' + data.name, 'success');
                }
            } catch (error) {
                log('Credentials fetch error: ' + error.message, 'error');
            }
        }

        async function testAngularLikeRequest() {
            log('Testing Angular-like request configuration...');
            try {
                const response = await fetch('/api/weather?city=London', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    credentials: 'same-origin',
                    cache: 'no-cache'
                });
                
                log('Angular-like status: ' + response.status, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('Angular-like success: ' + data.name, 'success');
                } else {
                    const errorText = await response.text();
                    log('Angular-like error: ' + errorText, 'error');
                }
            } catch (error) {
                log('Angular-like exception: ' + error.name + ' - ' + error.message, 'error');
            }
        }

        async function testWithHeaders() {
            log('Testing with various headers...');
            try {
                const response = await fetch('/api/weather?city=London', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log('Headers test status: ' + response.status, response.ok ? 'success' : 'error');
                log('Response headers: ' + JSON.stringify([...response.headers.entries()]));
                
                if (response.ok) {
                    const data = await response.json();
                    log('Headers test success: ' + data.name, 'success');
                }
            } catch (error) {
                log('Headers test error: ' + error.message, 'error');
            }
        }

        async function testCORS() {
            log('Testing CORS preflight simulation...');
            try {
                // First test OPTIONS request
                const optionsResponse = await fetch('/api/weather?city=London', {
                    method: 'OPTIONS'
                });
                log('OPTIONS status: ' + optionsResponse.status);
                log('CORS headers: ' + JSON.stringify([...optionsResponse.headers.entries()]));
                
                // Then test actual request
                const response = await fetch('/api/weather?city=London', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log('CORS test status: ' + response.status, response.ok ? 'success' : 'error');
            } catch (error) {
                log('CORS test error: ' + error.message, 'error');
            }
        }

        // Auto-run basic test
        window.addEventListener('load', function() {
            log('Page loaded, running automatic test...');
            setTimeout(testNativeFetch, 1000);
        });
    </script>
</body>
</html>
